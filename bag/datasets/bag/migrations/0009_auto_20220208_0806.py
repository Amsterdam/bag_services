# Generated by Django 2.2.24 on 2022-02-08 08:06

from django.conf import settings
from django.db import migrations, models
from psycopg2.extensions import QuotedString

from geo_views import migrate

URL = settings.DATAPUNT_API_URL


class Migration(migrations.Migration):

    dependencies = [
        ('bag', '0008_woonplaats_geometrie'),
        ('geo_views', '0002_gebiedsgerichtwerkenpraktijkgebieden_views')
    ]

    operations = [
        # Drop related views
        migrations.RunSQL("DROP VIEW IF EXISTS geo_bag_buurt, geo_bag_buurt_simple"),
        migrations.RunSQL("DROP MATERIALIZED VIEW IF EXISTS geo_bag_buurt_mat, geo_bag_buurt_simple_mat"),

        # Actual migration
        migrations.AlterField(
            model_name='buurt',
            name='code',
            field=models.CharField(max_length=4, unique=True),
        ),

        # Recreatie geo views
        migrate.ManageView(
            view_name='geo_bag_buurt',
            sql="""
    SELECT
      b.id                                            AS id,
      b.code                                          AS code,
      b.vollcode                                      AS vollcode,
      b.naam                                          AS naam,
      b.geometrie                                     AS geometrie,
      b.naam                                          AS display,
      'gebieden/buurt'::TEXT                          AS type,
      {} || 'gebieden/buurt/' || b.id || '/'          AS uri
    FROM bag_buurt b
    """.format(QuotedString(URL))
        ),

        migrate.ManageView(
            view_name='geo_bag_buurt_simple',
            sql="""
    SELECT
      b.id                                             AS id,
      b.code                                           AS code,
      b.vollcode                                       AS vollcode,
      b.naam                                           AS naam,
      ST_SimplifyPreserveTopology(b.geometrie, 0.1)    AS geometrie,
      b.naam                                           AS display,
      'gebieden/buurt'::TEXT                           AS type,
      {} || 'gebieden/buurt/' || b.id || '/'           AS uri
    FROM bag_buurt b
    """.format(QuotedString(URL))
        )
    ]
